version: 0.29.0

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: [results]
  requester:
    type: HttpRequester
    url_base: https://api.tempo.io/4/
    http_method: GET
    error_handler:
      type: CompositeErrorHandler
      # ignore 403 error but retry default retriable http errors (429, 500 - 600)
      error_handlers:
        - type: DefaultErrorHandler
          response_filters:
            - http_codes: [403]
              action: IGNORE
        - type: DefaultErrorHandler
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['api_token'] }}"
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      pagination_strategy:
        type: CursorPagination
        cursor_value: "{{ response['metadata']['next'] }}"
        stop_condition: "{{ 'next' not in response['metadata'] }}"
        page_size: 50
      page_size_option:
        field_name: limit
        inject_into: request_parameter
      page_token_option:
        type: RequestPath
  base_stream:
    primary_key: id
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
  accounts_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: accounts
      path: accounts
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          self:
            type: string
          key:
            type: string
          id:
            type: integer
          name:
            type: string
          status:
            type: string
          global:
            type: boolean
          monthlyBudget:
            type:
              - "null"
              - integer
          lead:
            type: object
            properties:
              self:
                type:
                  - "null"
                  - string
              accountId:
                type: string
          contact:
            type: object
            properties:
              self:
                type: string
              accountId:
                type: string
              type:
                type: string
          category:
            type: object
            properties:
              self:
                type: string
              key:
                type: string
              id:
                type: integer
              name:
                type: string
              type:
                type: object
                properties:
                  name:
                    type: string
          customer:
            type:
              - "null"
              - object
            properties:
              self:
                type: string
              key:
                type: string
              id:
                type: integer
              name:
                type: string
          links:
            type: object
            properties:
              self:
                type: string
  customers_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: customers
      path: customers
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          self:
            type: string
          key:
            type: string
          id:
            type: integer
          name:
            type: string
  worklogs_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester: "#/definitions/requester"
    incremental_sync:
      cursor_field: startDate
      datetime_format: "%Y-%m-%d"
      cursor_granularity: P1D
      start_datetime:
        datetime: "2020-01-01"
        datetime_format: "%Y-%m-%d"
      end_datetime:
        datetime: "{{ today_utc() }}"
        datetime_format: "%Y-%m-%d"
      step: P1W
      end_time_option:
        field_name: to
        inject_into: request_parameter
      start_time_option:
        field_name: from
        inject_into: request_parameter
      type: DatetimeBasedCursor
    $parameters:
      name: worklogs
      path: worklogs
    primary_key: tempoWorklogId
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          self:
            type: string
            description: The URL of the worklog
            format: uri
            readOnly: true
          tempoWorklogId:
            type: integer
            description: The ID of the tempo worklog.
            readOnly: true
          issue:
            type: object
            description: Details of the issue
            properties:
              id:
                type: integer
              self:
                type: string
            readOnly: true
          timeSpentSeconds:
            type: integer
            description: Time spend in seconds of the worklog
            readOnly: true
          startDate:
            type: string
            description: Start Date of the worklog
            readOnly: true
          startTime:
            type:
              - "null"
              - string
            description: Start time of the worklog
            readOnly: true
          description:
            type:
              - "null"
              - string
            description: Description of the worklog
            readOnly: true
          createdAt:
            type: string
            description: Created at date of the worklog
            readOnly: true
          updatedAt:
            type: string
            description: Updated at date of the worklog
            readOnly: true
          author:
            type: object
            description: Author of the worklog
            properties:
              accountId:
                type: string
              self:
                type:
                  - "null"
                  - string
            readOnly: true
          attributes:
            type: object
            properties:
              self:
                type: string
              values:
                type:
                  - "null"
                  - array
                items:
                  type: object
                  properties:
                    key:
                      type: string
                    value:
                      type:
                        - "null"
                        - string
            description: Additional attribute of the worklog
            readOnly: true
          billableSeconds:
            type:
              - "null"
              - integer
            description: Billable time spent working
  workload_schemes_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: workload-schemes
      path: workload-schemes

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          self:
            type: string
            description: The URL of the Workload Scheme
            format: uri
            readOnly: true
          id:
            type: integer
            description: The ID of the tempo Workload Scheme.
            readOnly: true
          name:
            type: string
            description: The name of the tempo Workload Scheme.
            readOnly: true
          description:
            type: string
            description: The description of the tempo Workload Scheme.
            readOnly: true
          defaultScheme:
            type: boolean
            description: The defaultScheme of the tempo Workload Scheme.
            readOnly: true
          memberCount:
            type: integer
            description: The memberCount of the tempo Workload Scheme.
            readOnly: true
          days:
            type: array
            description: The days of the tempo Workload Scheme.
            readOnly: true
            items:
              type: object
              properties:
                day:
                  type: string
                requiredSeconds:
                  type: integer
streams:
  - "#/definitions/accounts_stream"
  - "#/definitions/customers_stream"
  - "#/definitions/worklogs_stream"
  - "#/definitions/workload_schemes_stream"

check:
  type: CheckStream
  stream_names: [workload-schemes]
