version: 0.29.0

definitions:
  selector:
    extractor:
      field_path: [results]
  base_requester:
    url_base: https://newsdata.io/api/1
    http_method: GET
    authenticator:
      type: ApiKeyAuthenticator
      header: X-ACCESS-KEY
      api_token: "{{ config['api_key'] }}"
  base_retriever:
    record_selector:
      $ref: "#/definitions/selector"
  base_stream:
    retriever:
      $ref: "#/definitions/base_retriever"
      requester:
        $ref: "#/definitions/base_requester"
  cursor_paginator:
    type: DefaultPaginator
    pagination_strategy:
      type: CursorPagination
      cursor_value: "{{ response['nextPage'] }}"
      page_size: 10
      # TODO: make page_size dynamic, depending on free or paid tier. See https://github.com/airbytehq/airbyte/issues/18783
    page_token_option:
      type: RequestOption
      field_name: page
      inject_into: request_parameter
    page_size_option: # This is useless, only there because it is required, but page sizes are managed automatically by API subscription type
      field_name: X-Pagination-Page-Size
      inject_into: header
  latest_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: latest
      primary_key: link
      path: /news
    retriever:
      $ref: "#/definitions/base_retriever"
      requester:
        $ref: "#/definitions/base_requester"
        request_parameters:
          country: "{{ ','.join(config['country']) }}"
          language: "{{ ','.join(config['language']) }}"
          category: "{{ ','.join(config['category']) }}"
          q: "{{ config['query'] | urlencode }}"
          qInTitle: "{{ config['query_in_title'] | urlencode }}"
          domain: "{{ ','.join(config['domain']) }}"
      paginator:
        $ref: "#/definitions/cursor_paginator"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          title:
            type:
              - "null"
              - string
          link:
            type:
              - "null"
              - string
          source_id:
            type:
              - "null"
              - string
          keywords:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - string
          creator:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - string
          image_url:
            type:
              - "null"
              - string
          video_url:
            type:
              - "null"
              - string
          description:
            type:
              - "null"
              - string
          pubDate:
            type:
              - "null"
              - string
          content:
            type:
              - "null"
              - string
          country:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - string
          category:
            type:
              - "null"
              - array
            items:
              type: string
          language:
            type:
              - "null"
              - string
  sources_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: sources
      primary_key: id
      path: /sources
    retriever:
      $ref: "#/definitions/base_retriever"
      requester:
        $ref: "#/definitions/base_requester"
        request_parameters:
          country: "{{ config['country'][0] }}"
          language: "{{ config['language'][0] }}"
          category: "{{ config['category'][0] }}"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          url:
            type:
              - "null"
              - string
          category:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - string
          language:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - string
          country:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - string
streams:
  - "#/definitions/latest_stream"
  - "#/definitions/sources_stream"

check:
  stream_names:
    - latest
    - sources
